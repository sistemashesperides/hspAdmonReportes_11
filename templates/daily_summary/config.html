{% extends "admin/layout.html" %}
{% block title %}Configuración Resumen Diario{% endblock %}

{% block content %}
<h2>Configuración del Resumen Diario de Ventas</h2>
<hr>

<form method="post" id="configForm">
    <div class="card">
        <div class="card-body">
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="is_enabled" name="is_enabled" {% if config.is_enabled %}checked{% endif %}>
                <label class="form-check-label" for="is_enabled">Habilitar envío automático diario</label>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                     <label for="connection_id" class="form-label">Conexión BBDD <span class="text-danger">*</span></label>
                     <select class="form-select" name="connection_id" id="connection_id" required>
                         <option value="" disabled {% if not config.connection_id %}selected{% endif %}>-- Selecciona --</option>
                         {% for conn in connections %}<option value="{{ conn.id }}" {% if config.connection_id == conn.id %}selected{% endif %}>{{ conn.name }}</option>{% endfor %}
                     </select>
                </div>
                 <div class="col-md-6 mb-3">
                    <label for="schedule_time" class="form-label">Hora Envío (24h) <span class="text-danger">*</span></label>
                    <input type="time" class="form-control" name="schedule_time" id="schedule_time" value="{{ config.schedule_time or '08:00' }}" required>
                </div>
            </div>
             <div class="mb-3">
                <label for="subject" class="form-label">Asunto del Correo</label>
                <input type="text" class="form-control" name="subject" id="subject" value="{{ config.subject or 'Cierre de Ventas Diario Empresa: %empresa%' }}">
                <small class="form-text text-muted">Usa <code>%empresa%</code> para insertar nombre.</small>
            </div>
            <div class="mb-3">
                <label for="recipients" class="form-label">Destinatarios (separados por coma) <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="recipients" id="recipients" value="{{ config.recipients or '' }}" required>
            </div>

            <hr>
            <div class="mb-3">
                 <label for="sql_query" class="form-label">Consulta SQL del Resumen <span class="text-danger">*</span></label>
                 <textarea class="form-control font-monospace" name="sql_query" id="sql_query" rows="15" required>{{ config.sql_query or '' }}</textarea>
                 <small class="form-text text-muted">La consulta debe devolver 12 conjuntos de resultados en el orden esperado por la plantilla.</small>
            </div>

        </div>
        <div class="card-footer d-flex justify-content-between">
            <button type="button" class="btn btn-info" onclick="previewSummary()">Previsualizar Correo</button>
            <button type="submit" class="btn btn-primary">Guardar Configuración</button>
        </div>
    </div>
</form>

<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Previsualización del Correo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="previewModalBody" style="background-color: #f0f0f0;">
        </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));

async function previewSummary() {
        const connectionId = document.getElementById('connection_id').value;
        const sqlQuery = document.getElementById('sql_query').value;
        const previewBody = document.getElementById('previewModalBody');

        if (!connectionId || !sqlQuery) {
            alert('Por favor, selecciona una conexión y asegúrate de que la consulta SQL no esté vacía.');
            return;
        }

        previewBody.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="min-height: 200px;"><div class="spinner-border" role="status"><span class="visually-hidden">Cargando...</span></div></div>';
        previewModal.show();

        try {
            const response = await fetch("{{ url_for('daily_summary.preview') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ connection_id: connectionId, sql_query: sqlQuery })
            });

            // --- MANEJO DE ERRORES MEJORADO ---
            if (!response.ok) {
                let errorMsg = `Error ${response.status}`;
                let debugLogHtml = '';
                try {
                    // Intenta leer el JSON de error que ahora puede incluir el log
                    const errorData = await response.json();
                    errorMsg = errorData.error || errorMsg; // Usa el mensaje de error del backend
                    if (errorData.debug_log && Array.isArray(errorData.debug_log)) {
                         // Formatea el log para mostrarlo claramente
                         debugLogHtml = '<h5>Log de Depuración:</h5><pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #eee; padding: 10px; border-radius: 5px;">'
                                        + errorData.debug_log.join('\n')
                                        + '</pre>';
                    }
                } catch (e) {
                    // Si la respuesta no es JSON o hay otro error, muestra el texto plano
                    errorMsg = await response.text();
                }
                // Muestra el error y el log (si existe) en el modal
                throw new Error(`${errorMsg}\n\n${debugLogHtml}`); // Lanza error para ir al catch
            }
            // --- FIN MANEJO DE ERRORES ---

            // Si la respuesta es OK (200), muestra el HTML en el iframe
            const htmlPreview = await response.text();
            previewBody.innerHTML = `<iframe srcdoc="${htmlPreview.replace(/"/g, '&quot;')}" style="width: 100%; height: 60vh; border: none;"></iframe>`;

        } catch (error) {
            // Muestra el mensaje de error (que ahora puede incluir el log formateado)
            console.error('Preview error:', error);
            // Usamos innerHTML porque el error puede contener HTML (<pre>)
            previewBody.innerHTML = `<div class="alert alert-danger">${error.message.replace(/\n/g, '<br>')}</div>`;
        }
    }
</script>
{% endblock %}