{% extends "admin/layout.html" %}

{% block title %}Conexiones de Base de Datos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Conexiones de Base de Datos</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#connectionModal" onclick="prepareNewConnection()">
        <i class="bi bi-plus-circle"></i> Añadir Nueva Conexión
    </button>
</div>

<div class="card">
    <div class="card-body">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Servidor</th>
                    <th>Base de Datos</th>
                    <th>Usuario</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for conn in connections %}
                <tr>
                    <td>{{ conn.name }}</td>
                    <td>{{ conn.server }}</td>
                    <td>{{ conn.database }}</td>
                    <td>{{ conn.username }}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-secondary"
                                data-conn='{{ conn | tojson | safe }}'
                                onclick="prepareEditConnection(this)">
                            Editar
                        </button>
                        <form method="post" action="{{ url_for('admin.connections') }}" style="display: inline;">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="id" value="{{ conn.id }}">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('¿Estás seguro?')">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center">No hay conexiones configuradas.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="connectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="connectionModalLabel">Añadir Conexión</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="connectionForm" method="post" action="{{ url_for('admin.connections') }}">
                <div class="modal-body">
                    <input type="hidden" name="action" id="formAction" value="save">
                    <input type="hidden" name="id" id="formId">
                    <div class="mb-3">
                        <label for="name" class="form-label">Nombre Descriptivo</label>
                        <input type="text" class="form-control" name="name" id="formName" required>
                    </div>
                    <div class="mb-3">
                        <label for="server" class="form-label">Servidor</label>
                        <input type="text" class="form-control" name="server" id="formServer" required>
                    </div>
                    <div class="mb-3">
                        <label for="database" class="form-label">Base de Datos</label>
                        <input type="text" class="form-control" name="database" id="formDatabase" required>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Usuario</label>
                        <input type="text" class="form-control" name="username" id="formUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" name="password" id="formPassword">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-info" onclick="testCurrentConnection()">Probar Conexión</button>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const connectionModal = new bootstrap.Modal(document.getElementById('connectionModal'));

    function prepareNewConnection() {
        document.getElementById('connectionModalLabel').innerText = 'Añadir Nueva Conexión';
        document.getElementById('connectionForm').reset();
        document.getElementById('formId').value = '';
        document.getElementById('formPassword').required = true;
        document.getElementById('formPassword').placeholder = '';
    }

    // ===================== CORRECCIÓN CLAVE AQUÍ =====================
    function prepareEditConnection(buttonElement) {
        const connString = buttonElement.getAttribute('data-conn');
        const conn = JSON.parse(connString);

        document.getElementById('connectionModalLabel').innerText = 'Editar Conexión';
        document.getElementById('connectionForm').reset();
        document.getElementById('formId').value = conn.id;
        document.getElementById('formName').value = conn.name;
        document.getElementById('formServer').value = conn.server;
        document.getElementById('formDatabase').value = conn.database;
        document.getElementById('formUsername').value = conn.username;
        // La contraseña no se rellena por seguridad. Se hace opcional al editar.
        document.getElementById('formPassword').required = false;
        document.getElementById('formPassword').placeholder = 'Dejar en blanco para no cambiar';
        
        connectionModal.show();
    }
    // ===================================================================

    async function testCurrentConnection() {
        const formData = new FormData(document.getElementById('connectionForm'));
        const data = Object.fromEntries(formData.entries());
        data.driver = '{ODBC Driver 17 for SQL Server}'; 

        const response = await fetch("{{ url_for('admin.test_db_connection') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        alert(result.message);
    }
</script>
{% endblock %}