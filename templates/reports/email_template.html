<!DOCTYPE html>
<html lang="es">
<head><meta charset="UTF-8"><title>{{ title }}</title></head>
<body style="font-family: Arial, sans-serif; margin: 20px; color: #333; font-size: 12px;">
    <table width="100%" cellspacing="0" cellpadding="0" style="max-width: 800px; margin: auto;">
        <tr><td style="text-align: center; padding-bottom: 20px;">
            {% if logo_path %}<img src="{{ logo_path }}" alt="Logo" style="max-height: 60px; margin-bottom: 10px;">{% endif %}
            {% if branding.header_text %}<pre style="font-family: Arial, sans-serif; font-size: 11px; color: #555; margin: 0; white-space: pre-wrap;">{{ branding.header_text }}</pre>{% endif %}
            <h2 style="margin: 10px 0; font-size: 18px;">{{ title }}</h2>
        </td></tr>
        <tr><td>
            <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse: collapse; border: 1px solid #ddd;">
                <thead><tr style="background-color: #f2f2f2;">
                    {% for col in columns %}<th style="padding: 8px; border: 1px solid #ddd; text-align: left; font-weight: bold;">{{ col }}</th>{% endfor %}
                </tr></thead>
                <tbody>
                    {% if grouped_data %}
                        {% for group_name, group_info in grouped_data.items() %}
                            <tr style="background-color: #e0e0e0; font-weight: bold;"><td colspan="{{ columns | length }}" style="padding: 8px; border: 1px solid #ddd;">{{ group_by_field }}: {{ group_name }}</td></tr>
                            {% for row in group_info.rows %}
                            <tr>{% for col in columns %}<td style="padding: 8px; border: 1px solid #ddd; {{ 'text-align: right;' if col in total_fields else '' }}">{{ row[col] }}</td>{% endfor %}</tr>
                            {% endfor %}
                            {% if group_info.subtotals %}
                            <tr style="background-color: #f0f0f0; font-weight: bold; border-top: 2px solid #aaa;">
                                {% for col in columns %}
                                    {% if col == group_by_field %}<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">Subtotal:</td>
                                    {% elif col in total_fields %}<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">{{ group_info.subtotals[col] }}</td>
                                    {% else %}<td style="padding: 8px; border: 1px solid #ddd;"></td>{% endif %}
                                {% endfor %}
                            </tr>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        {% for row in data_rows %}
                        <tr>{% for col in columns %}<td style="padding: 8px; border: 1px solid #ddd; {{ 'text-align: right;' if col in total_fields else '' }}">{{ row[col] }}</td>{% endfor %}</tr>
                        {% endfor %}
                    {% endif %}
                    {% if grand_totals %}
                    <tr style="background-color: #e8e8e8; font-weight: bold; border-top: 2px solid #555;">
                        {% for col in columns %}
                            {% if loop.first %}<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">TOTAL GENERAL:</td>
                            {% elif col in total_fields %}<td style="padding: 8px; border: 1px solid #ddd; text-align: right;">{{ grand_totals[col] }}</td>
                            {% else %}<td style="padding: 8px; border: 1px solid #ddd;"></td>{% endif %}
                        {% endfor %}
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </td></tr>
        {% if chart_image %}
        <tr><td style="text-align: center; padding-top: 20px;"><img src="{{ chart_image }}" style="max-width: 90%; height: auto;" alt="Gráfico"></td></tr>
        {% endif %}
        <tr><td style="padding-top: 20px; text-align: center; font-size: 11px; color: #888;">Reporte generado automáticamente.</td></tr>
    </table>
</body>
</html>